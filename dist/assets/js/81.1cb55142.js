(window.webpackJsonp=window.webpackJsonp||[]).push([[81],{470:function(s,e,t){"use strict";t.r(e);var r=t(54),a=Object(r.a)({},(function(){var s=this,e=s.$createElement,t=s._self._c||e;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"redis-cluster集群"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#redis-cluster集群"}},[s._v("#")]),s._v(" redis cluster集群")]),s._v(" "),t("p",[s._v("redis cluster集群是由多个主从节点组成的分布式服务器群，它具有复制、高可用、分片的特点。\nredis cluster不需要sentinel哨兵也能完成节点移除和故障转移。\n需要将每个节点设置成集群模式，这种集群模式没有中心节点，可以水平扩展，官方称可以线性扩展到1000个节点。\nredis cluster的性能优于redis sentinel模式。")]),s._v(" "),t("p",[t("a",{attrs:{"data-fancybox":"",title:"111",href:"redis-cluster工作原理.png"}},[t("img",{attrs:{src:"redis-cluster%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86.png",alt:"img.png"}})])]),s._v(" "),t("p",[s._v("redis官方的槽总数为：16384 ， redis-cluster所有的槽位总数需要等于16384，这里目的是实现数据的分区（set和get）\n客户端发起 set hello world请求后，redis-cluster会使用 crc16(hello)做算法，并且对16384取模，获得槽位值，用来确定到具体哪个集群。")]),s._v(" "),t("h2",{attrs:{id:"redis-cluster集群特点"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#redis-cluster集群特点"}},[s._v("#")]),s._v(" Redis Cluster集群特点")]),s._v(" "),t("p",[t("a",{attrs:{"data-fancybox":"",title:"111",href:"redis-cluster无中心化架构图.png"}},[t("img",{attrs:{src:"redis-cluster%E6%97%A0%E4%B8%AD%E5%BF%83%E5%8C%96%E6%9E%B6%E6%9E%84%E5%9B%BE.png",alt:"img.png"}})])]),s._v(" "),t("ol",[t("li",[s._v("RedisCluster集群完全去中心化，采用多主多从，所有的redis节点彼此之间使用 ping-pong机制（进行数据交互机制）连接，内部使用二机制协议优化传输速度和带宽")]),s._v(" "),t("li",[s._v("只需要连接集群其中一个redis节点，不需要任何中间件")]),s._v(" "),t("li",[s._v("每一个分区都是由一个 Redis 主机和多个从机组成，分片和分片之间是相互平行的")]),s._v(" "),t("li",[s._v("每一个master节点负责维护一部分槽位，以及槽里映射对应的key数据，集群每个节点都有全量槽信息，通过槽每个node都知道具体数据存储到哪个节点上")])]),s._v(" "),t("h2",{attrs:{id:"配置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#配置"}},[s._v("#")]),s._v(" 配置")]),s._v(" "),t("ul",[t("li",[s._v("修改 nodes-6379.conf 配置文件")])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("port 6379 # 修改端口\npidfile /var/run/redis_6379.pid # 改pid文件\n# 普通 Redis 实例不能成为 Redis 集群的一部分；只有作为集群节点启动的节点才可以。要将 Redis 实例作为集群节点启动，请启用集群支持，取消注释以下内容：\ncluster-enabled yes # 开启集群\n# 每个集群节点都有一个集群配置文件。此文件不适合手动编辑。它由 Redis 节点创建和更新。每个 Redis Cluster 节点都需要不同的集群配置文件。确保在同一系统中运行的实例没有重叠的集群配置文件名。\ncluster-config-file nodes-6379.conf\n# 集群节点超时\ncluster-node-timeout 15000\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")])]),t("ul",[t("li",[t("p",[s._v("使用docker-compose 部署 redis-cluster : docker-compose -f redis-clsuter.yml up -d")])]),s._v(" "),t("li",[t("p",[s._v("查看启动的redis进程： ps -ef|grep redis ，此时redis-cluster只是以cluster集群方式启动，目前还没有形成集群主从关系\n"),t("a",{attrs:{"data-fancybox":"",title:"111",href:"查看redis-cluster进程.png"}},[t("img",{attrs:{src:"%E6%9F%A5%E7%9C%8Bredis-cluster%E8%BF%9B%E7%A8%8B.png",alt:"img.png"}})])])]),s._v(" "),t("li",[t("p",[s._v("cluster meet ip port :\ncluster forget 集群id\ncluster meet 192.168.2.9 6376")])])]),s._v(" "),t("p",[t("a",{attrs:{"data-fancybox":"",title:"111",href:"cluster集群操作.png"}},[t("img",{attrs:{src:"cluster%E9%9B%86%E7%BE%A4%E6%93%8D%E4%BD%9C.png",alt:"img.png"}})])]),s._v(" "),t("ul",[t("li",[s._v("redis-cli --cluster help")]),s._v(" "),t("li",[s._v("构建集群关系")])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("  redis-cli --cluster create 192.168.2.11:6379 192.168.2.11:6378 192.168.2.11:6377 192.168.2.9:6375 192.168.2.9:6376 192.168.2.9:6373 192.168.2.9:6374 --cluster-replicas 1\n  redis cluster的槽位是根据节点数平均分配的，只需要配置主从节点比，一般写1就可以\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[t("a",{attrs:{"data-fancybox":"",title:"111",href:"redis-cluster创建集群.png"}},[t("img",{attrs:{src:"redis-cluster%E5%88%9B%E5%BB%BA%E9%9B%86%E7%BE%A4.png",alt:"img.png"}})])]),s._v(" "),t("ul",[t("li",[s._v("cluster nodes\n"),t("a",{attrs:{"data-fancybox":"",title:"111",href:"redis-cluster-nodes.png"}},[t("img",{attrs:{src:"redis-cluster-nodes.png",alt:"img.png"}})]),s._v("\n发现 master 节点有自动分配的槽位\n1 connected 0-5460\n2 connected 10923-16383\n4 connected 5461-10922")])]),s._v(" "),t("p",[s._v("比如命令")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("127.0.0.1:6379> set kee a 123\n(error) MOVED 9030 192.168.2.9:6375\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("因为 kee 通过crc16算法算出来的值不在 6379 槽位值中，所以报错提示 MOVED ....\n可以使用 redis-cli h 127.0.0.1 -p 6379 -c : 以集群方式进入命令端，再执行\n"),t("a",{attrs:{"data-fancybox":"",title:"111",href:"img_1.png"}},[t("img",{attrs:{src:"img_1.png",alt:"img_1.png"}})])]),s._v(" "),t("ul",[t("li",[s._v("扩容，加入集群 add-node")])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("add-node       new_host:new_port existing_host:existing_port # 是原集群的任意一个节点      \n                --cluster-slave # 以从节点的角色加入集群，若没有设置，则以主节点方式加入\n                --cluster-master-id <arg> # 以从节点角色加入方式，需要被加入主节点的id\n   \n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("p",[s._v("主节点角色加入： redis-cli --cluster add-node 192.168.2.9:1000 191.168.2.11:6379"),t("br"),s._v(" "),t("a",{attrs:{"data-fancybox":"",title:"111",href:"redis-cluster主节点角色加入1.png"}},[t("img",{attrs:{src:"redis-cluster%E4%B8%BB%E8%8A%82%E7%82%B9%E8%A7%92%E8%89%B2%E5%8A%A0%E5%85%A51.png",alt:"img.png"}})]),s._v(" "),t("a",{attrs:{"data-fancybox":"",title:"111",href:"redis-cluster主节点角色加入2.png"}},[t("img",{attrs:{src:"redis-cluster%E4%B8%BB%E8%8A%82%E7%82%B9%E8%A7%92%E8%89%B2%E5%8A%A0%E5%85%A52.png",alt:"img_1.png"}})])]),s._v(" "),t("p",[s._v("配置槽： 主节点角色加入需要配置槽位，参考 reshard命令\n从节点角色加入： redis-cli --cluster add-node 192.168.2.9:2000 191.168.2.11:6379 --cluster-slave --cluster-master-id 主节点id\n"),t("a",{attrs:{"data-fancybox":"",title:"111",href:"redis-cluster从节点角色加入1.png"}},[t("img",{attrs:{src:"redis-cluster%E4%BB%8E%E8%8A%82%E7%82%B9%E8%A7%92%E8%89%B2%E5%8A%A0%E5%85%A51.png",alt:"img_4.png"}})]),s._v(" "),t("a",{attrs:{"data-fancybox":"",title:"111",href:"redis-cluster从节点角色加入2.png"}},[t("img",{attrs:{src:"redis-cluster%E4%BB%8E%E8%8A%82%E7%82%B9%E8%A7%92%E8%89%B2%E5%8A%A0%E5%85%A52.png",alt:"img_5.png"}})])]),s._v(" "),t("p",[t("a",{attrs:{"data-fancybox":"",title:"111",href:"redis-cluster从节点角色加入4.png"}},[t("img",{attrs:{src:"redis-cluster%E4%BB%8E%E8%8A%82%E7%82%B9%E8%A7%92%E8%89%B2%E5%8A%A0%E5%85%A54.png",alt:"img_7.png"}})]),s._v(" "),t("a",{attrs:{"data-fancybox":"",title:"111",href:"redis-cluster从节点角色加入3.png"}},[t("img",{attrs:{src:"redis-cluster%E4%BB%8E%E8%8A%82%E7%82%B9%E8%A7%92%E8%89%B2%E5%8A%A0%E5%85%A53.png",alt:"img_6.png"}})])]),s._v(" "),t("ul",[t("li",[s._v("分配槽位  reshard")])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("reshard        host:port\n                --cluster-from <arg>\n                --cluster-to <arg>\n                --cluster-slots <arg>\n                --cluster-yes\n                --cluster-timeout <arg>\n                --cluster-pipeline <arg>\n                --cluster-replace\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")])]),t("p",[s._v("redis-cli --cluster reshard 192.168.2.11:1000\n会重新进入create界面，对这个新主节点重新分配槽位的界面")]),s._v(" "),t("p",[t("a",{attrs:{"data-fancybox":"",title:"111",href:"redis-cluster分配槽位1.png"}},[t("img",{attrs:{src:"redis-cluster%E5%88%86%E9%85%8D%E6%A7%BD%E4%BD%8D1.png",alt:"img_2.png"}})]),s._v(" "),t("a",{attrs:{"data-fancybox":"",title:"111",href:"redis-cluster分配槽位2.png"}},[t("img",{attrs:{src:"redis-cluster%E5%88%86%E9%85%8D%E6%A7%BD%E4%BD%8D2.png",alt:"img_3.png"}})])]),s._v(" "),t("ul",[t("li",[s._v("缩容\n主节点：需要把槽位去除，\nredis-cli --cluster reshard --cluster-from 被缩容的节点ip:port --cluster-to 迁到的主节点ip:port --cluster-slots 1000(缩的槽位数量)")])]),s._v(" "),t("p",[s._v("-剔除节点 : 建议先删除从节点，再删除主节点\nredis-cli --cluster del-node 192.168.2.11:1000 节点ID")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("\nroot@0a2197c5c17d:/data# redis-cli --cluster help\nCluster Manager Commands:\ncreate         host1:port1 ... hostN:portN\n                --cluster-replicas <arg> # 分配主从的规则，如果arg是1，则主从节点是 1：1\n\ncheck          host:port\n                --cluster-search-multiple-owners\ninfo           host:port\nfix            host:port\n                --cluster-search-multiple-owners\n                --cluster-fix-with-unreachable-masters\nreshard        host:port\n                --cluster-from <arg>\n                --cluster-to <arg>\n                --cluster-slots <arg>\n                --cluster-yes\n                --cluster-timeout <arg>\n                --cluster-pipeline <arg>\n                --cluster-replace\nrebalance      host:port\n                --cluster-weight <node1=w1...nodeN=wN>\n                --cluster-use-empty-masters\n                --cluster-timeout <arg>\n                --cluster-simulate\n                --cluster-pipeline <arg>\n                --cluster-threshold <arg>\n                --cluster-replace\nadd-node       new_host:new_port existing_host:existing_port\n                --cluster-slave\n                --cluster-master-id <arg>\ndel-node       host:port node_id\ncall           host:port command arg arg .. arg\n                --cluster-only-masters\n                --cluster-only-replicas\nset-timeout    host:port milliseconds\nimport         host:port\n                --cluster-from <arg>\n                --cluster-from-user <arg>\n                --cluster-from-pass <arg>\n                --cluster-from-askpass\n                --cluster-copy\n                --cluster-replace\nbackup         host:port backup_directory\nhelp\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br"),t("span",{staticClass:"line-number"},[s._v("35")]),t("br"),t("span",{staticClass:"line-number"},[s._v("36")]),t("br"),t("span",{staticClass:"line-number"},[s._v("37")]),t("br"),t("span",{staticClass:"line-number"},[s._v("38")]),t("br"),t("span",{staticClass:"line-number"},[s._v("39")]),t("br"),t("span",{staticClass:"line-number"},[s._v("40")]),t("br"),t("span",{staticClass:"line-number"},[s._v("41")]),t("br"),t("span",{staticClass:"line-number"},[s._v("42")]),t("br"),t("span",{staticClass:"line-number"},[s._v("43")]),t("br"),t("span",{staticClass:"line-number"},[s._v("44")]),t("br"),t("span",{staticClass:"line-number"},[s._v("45")]),t("br")])]),t("ul",[t("li",[s._v("redis集群启动命令")])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("redis-cli --cluster create 192.168.2.11:6379 192.168.2.11:6378 192.168.2.11:6377 192.168.2.9:6375 192.168.2.9:6376 192.168.2.9:6373 192.168.2.9:6374 --cluster-replicas 1\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("ul",[t("li",[s._v("redis节点个数\nredis集群至少需要有3个节点，因为投票的容错机制要求超过半数节点都认为这个节点挂掉才会被认可挂掉 ！所以2个节点是无法构成集群的\n要保证高可用的，需要每个节点都有从节点，所以redis集群最少需要有6个节点。")])]),s._v(" "),t("p",[t("a",{attrs:{"data-fancybox":"",title:"111",href:"redis-cluster节点数要求.png"}},[t("img",{attrs:{src:"redis-cluster%E8%8A%82%E7%82%B9%E6%95%B0%E8%A6%81%E6%B1%82.png",alt:"img.png"}})])]),s._v(" "),t("ul",[t("li",[s._v("问题 ： 在创建redis集群后，会一直停留在 ： Waiting for the cluster to join ........ 的状态")])]),s._v(" "),t("p",[s._v("Redis集群TCP端口，每个Redis集群节点都要打开两个TCP端口，一个是给客户端用的端口（比如 6379），一个是用于集群总线即是使用二进制协议的节点到节点通信的通道（比如 16379），第二个端口在第一个普通端口之上 +10000")]),s._v(" "),t("HideArticle")],1)}),[],!1,null,null,null);e.default=a.exports}}]);