(window.webpackJsonp=window.webpackJsonp||[]).push([[88],{478:function(n,s,a){"use strict";a.r(s);var e=a(54),t=Object(e.a)({},(function(){var n=this,s=n.$createElement,a=n._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":n.$parent.slotKey}},[a("h1",{attrs:{id:"死信队列"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#死信队列"}},[n._v("#")]),n._v(" 死信队列")]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v("死信队列\n     1 死信队列：DLX ， dead-letter-exchange\n     2 死信： 当一个消息变成死信后，会被published到另外一个队列就是DLX死信队列\n\n死信：\n    1 消息被拒绝 channel.basicReject()、channel.basicNack() 并且requeue=false (重新进入队列)\n    2 当前队列中的消息数量已经超过最大长度\n    3 当前消息在队列中的存活时间已经超过了预先设置的TTL(Time To Live)时间\n    \n应用场景：\n    电商平台里的提交订单，在规定时间若没有完成支付，则回滚库存、取消订单！  （参考'延迟消息投递-其底层也是使用死信实现的'）    \n\n")])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br"),a("span",{staticClass:"line-number"},[n._v("2")]),a("br"),a("span",{staticClass:"line-number"},[n._v("3")]),a("br"),a("span",{staticClass:"line-number"},[n._v("4")]),a("br"),a("span",{staticClass:"line-number"},[n._v("5")]),a("br"),a("span",{staticClass:"line-number"},[n._v("6")]),a("br"),a("span",{staticClass:"line-number"},[n._v("7")]),a("br"),a("span",{staticClass:"line-number"},[n._v("8")]),a("br"),a("span",{staticClass:"line-number"},[n._v("9")]),a("br"),a("span",{staticClass:"line-number"},[n._v("10")]),a("br"),a("span",{staticClass:"line-number"},[n._v("11")]),a("br"),a("span",{staticClass:"line-number"},[n._v("12")]),a("br")])]),a("h2",{attrs:{id:"_1-生产者队列、交换器、路由绑定配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-生产者队列、交换器、路由绑定配置"}},[n._v("#")]),n._v(" 1. 生产者队列、交换器、路由绑定配置")]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v('package com.mqz.better.rabbitmq.provider.config;\nimport com.mqz.better.rabbitmq.common.constants.Constant;\nimport org.springframework.amqp.core.*;\nimport org.springframework.amqp.rabbit.annotation.Exchange;\nimport org.springframework.amqp.rabbit.config.SimpleRabbitListenerContainerFactory;\nimport org.springframework.amqp.rabbit.connection.ConnectionFactory;\nimport org.springframework.amqp.rabbit.core.RabbitTemplate;\nimport org.springframework.amqp.support.converter.SerializerMessageConverter;\nimport org.springframework.beans.factory.annotation.Qualifier;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Configuration;\nimport org.springframework.context.annotation.Scope;\n\nimport java.util.HashMap;\nimport java.util.Map;\n\n/**\n *  版权所有 © Copyright 2012<br>\n *\n * @Author： 蒙大拿\n * @Date：2021/9/11 3:49 下午\n * @Description\n * @About： https://github.com/DemoMeng\n */\n@Configuration\npublic class RabbitDeadConfig {\n\n\n    /**\n     * 死信队列跟交换机类型没有关系 不一定为directExchange  不影响该类型交换机的特性.\n     */\n    @Bean(Constant.DEAD_EXCHANGE)\n    public DirectExchange deadLetterExchange() {\n        return ExchangeBuilder.directExchange(Constant.DEAD_EXCHANGE).durable(true).build();\n    }\n\n    /**\n     * 声明一个死信队列.\n     * x-dead-letter-exchange   对应  死信交换机\n     * x-dead-letter-routing-key  对应 死信队列\n     */\n    @Bean(Constant.DEAD_QUEUE)\n    public Queue deadLetterQueue() {\n        Map<String, Object> args = new HashMap<>(3);\n        args.put("x-dead-letter-exchange", Constant.DEAD_EXCHANGE);\n        args.put("x-dead-letter-routing-key",Constant.DEAD_ROUTING_KEY);\n        args.put("x-message-ttl",5000);//过期时间\n        return QueueBuilder.durable(Constant.DEAD_QUEUE).withArguments(args).build();\n    }\n\n    /**\n     * 死信路由通过 绑定键绑定到死信队列上.\n     * @return the binding\n     */\n    @Bean\n    public Binding createDeadQueueBinding(@Qualifier(Constant.DEAD_QUEUE) Queue queue,\n                                          @Qualifier(Constant.DEAD_EXCHANGE) DirectExchange topicExchange){//共用同一个交换机\n        return BindingBuilder.bind(queue).to(topicExchange).with(Constant.DEAD_ROUTING_KEY);\n    }\n\n    /**\n     * 定义死信队列转发队列.\n     * @return the queue\n     */\n    @Bean(Constant.DEAD_QUEUE_RE)\n    public Queue redirectQueue() {\n        return QueueBuilder.durable(Constant.DEAD_QUEUE_RE).build();\n    }\n\n    /**\n     * 绑定转发队列\n     */\n    @Bean\n    public Binding redirectBinding(@Qualifier(Constant.DEAD_QUEUE_RE) Queue queue,\n                                   @Qualifier(Constant.DEAD_EXCHANGE) DirectExchange topicExchange){//共用同一个交换机\n        return BindingBuilder.bind(queue).to(topicExchange).with(Constant.DEAD_ROUTING_KEY);\n    }\n\n    //死信如果过期后会被丢弃，如果这个死信原来的队列绑定了死信队列的交换机，那么会重新进入绑定这个死信队列的队列中重新消费\n    @Bean\n    public Binding ttlBinding(@Qualifier(Constant.TTL_QUEUE) Queue queue,\n                              @Qualifier(Constant.DEAD_EXCHANGE) DirectExchange topicExchange){\n        return BindingBuilder.bind(queue).to(topicExchange).with(Constant.DEAD_ROUTING_KEY);\n    }\n}\n')])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br"),a("span",{staticClass:"line-number"},[n._v("2")]),a("br"),a("span",{staticClass:"line-number"},[n._v("3")]),a("br"),a("span",{staticClass:"line-number"},[n._v("4")]),a("br"),a("span",{staticClass:"line-number"},[n._v("5")]),a("br"),a("span",{staticClass:"line-number"},[n._v("6")]),a("br"),a("span",{staticClass:"line-number"},[n._v("7")]),a("br"),a("span",{staticClass:"line-number"},[n._v("8")]),a("br"),a("span",{staticClass:"line-number"},[n._v("9")]),a("br"),a("span",{staticClass:"line-number"},[n._v("10")]),a("br"),a("span",{staticClass:"line-number"},[n._v("11")]),a("br"),a("span",{staticClass:"line-number"},[n._v("12")]),a("br"),a("span",{staticClass:"line-number"},[n._v("13")]),a("br"),a("span",{staticClass:"line-number"},[n._v("14")]),a("br"),a("span",{staticClass:"line-number"},[n._v("15")]),a("br"),a("span",{staticClass:"line-number"},[n._v("16")]),a("br"),a("span",{staticClass:"line-number"},[n._v("17")]),a("br"),a("span",{staticClass:"line-number"},[n._v("18")]),a("br"),a("span",{staticClass:"line-number"},[n._v("19")]),a("br"),a("span",{staticClass:"line-number"},[n._v("20")]),a("br"),a("span",{staticClass:"line-number"},[n._v("21")]),a("br"),a("span",{staticClass:"line-number"},[n._v("22")]),a("br"),a("span",{staticClass:"line-number"},[n._v("23")]),a("br"),a("span",{staticClass:"line-number"},[n._v("24")]),a("br"),a("span",{staticClass:"line-number"},[n._v("25")]),a("br"),a("span",{staticClass:"line-number"},[n._v("26")]),a("br"),a("span",{staticClass:"line-number"},[n._v("27")]),a("br"),a("span",{staticClass:"line-number"},[n._v("28")]),a("br"),a("span",{staticClass:"line-number"},[n._v("29")]),a("br"),a("span",{staticClass:"line-number"},[n._v("30")]),a("br"),a("span",{staticClass:"line-number"},[n._v("31")]),a("br"),a("span",{staticClass:"line-number"},[n._v("32")]),a("br"),a("span",{staticClass:"line-number"},[n._v("33")]),a("br"),a("span",{staticClass:"line-number"},[n._v("34")]),a("br"),a("span",{staticClass:"line-number"},[n._v("35")]),a("br"),a("span",{staticClass:"line-number"},[n._v("36")]),a("br"),a("span",{staticClass:"line-number"},[n._v("37")]),a("br"),a("span",{staticClass:"line-number"},[n._v("38")]),a("br"),a("span",{staticClass:"line-number"},[n._v("39")]),a("br"),a("span",{staticClass:"line-number"},[n._v("40")]),a("br"),a("span",{staticClass:"line-number"},[n._v("41")]),a("br"),a("span",{staticClass:"line-number"},[n._v("42")]),a("br"),a("span",{staticClass:"line-number"},[n._v("43")]),a("br"),a("span",{staticClass:"line-number"},[n._v("44")]),a("br"),a("span",{staticClass:"line-number"},[n._v("45")]),a("br"),a("span",{staticClass:"line-number"},[n._v("46")]),a("br"),a("span",{staticClass:"line-number"},[n._v("47")]),a("br"),a("span",{staticClass:"line-number"},[n._v("48")]),a("br"),a("span",{staticClass:"line-number"},[n._v("49")]),a("br"),a("span",{staticClass:"line-number"},[n._v("50")]),a("br"),a("span",{staticClass:"line-number"},[n._v("51")]),a("br"),a("span",{staticClass:"line-number"},[n._v("52")]),a("br"),a("span",{staticClass:"line-number"},[n._v("53")]),a("br"),a("span",{staticClass:"line-number"},[n._v("54")]),a("br"),a("span",{staticClass:"line-number"},[n._v("55")]),a("br"),a("span",{staticClass:"line-number"},[n._v("56")]),a("br"),a("span",{staticClass:"line-number"},[n._v("57")]),a("br"),a("span",{staticClass:"line-number"},[n._v("58")]),a("br"),a("span",{staticClass:"line-number"},[n._v("59")]),a("br"),a("span",{staticClass:"line-number"},[n._v("60")]),a("br"),a("span",{staticClass:"line-number"},[n._v("61")]),a("br"),a("span",{staticClass:"line-number"},[n._v("62")]),a("br"),a("span",{staticClass:"line-number"},[n._v("63")]),a("br"),a("span",{staticClass:"line-number"},[n._v("64")]),a("br"),a("span",{staticClass:"line-number"},[n._v("65")]),a("br"),a("span",{staticClass:"line-number"},[n._v("66")]),a("br"),a("span",{staticClass:"line-number"},[n._v("67")]),a("br"),a("span",{staticClass:"line-number"},[n._v("68")]),a("br"),a("span",{staticClass:"line-number"},[n._v("69")]),a("br"),a("span",{staticClass:"line-number"},[n._v("70")]),a("br"),a("span",{staticClass:"line-number"},[n._v("71")]),a("br"),a("span",{staticClass:"line-number"},[n._v("72")]),a("br"),a("span",{staticClass:"line-number"},[n._v("73")]),a("br"),a("span",{staticClass:"line-number"},[n._v("74")]),a("br"),a("span",{staticClass:"line-number"},[n._v("75")]),a("br"),a("span",{staticClass:"line-number"},[n._v("76")]),a("br"),a("span",{staticClass:"line-number"},[n._v("77")]),a("br"),a("span",{staticClass:"line-number"},[n._v("78")]),a("br"),a("span",{staticClass:"line-number"},[n._v("79")]),a("br"),a("span",{staticClass:"line-number"},[n._v("80")]),a("br"),a("span",{staticClass:"line-number"},[n._v("81")]),a("br"),a("span",{staticClass:"line-number"},[n._v("82")]),a("br"),a("span",{staticClass:"line-number"},[n._v("83")]),a("br"),a("span",{staticClass:"line-number"},[n._v("84")]),a("br"),a("span",{staticClass:"line-number"},[n._v("85")]),a("br")])]),a("h2",{attrs:{id:"_2-消息生产者发送消息"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-消息生产者发送消息"}},[n._v("#")]),n._v(" 2. 消息生产者发送消息")]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v('package com.mqz.better.rabbitmq.provider.provider;\n\nimport com.mqz.better.rabbitmq.common.constants.Constant;\nimport com.mqz.better.rabbitmq.common.model.dto.MessageDTO;\nimport lombok.extern.slf4j.Slf4j;\nimport org.springframework.amqp.core.ReturnedMessage;\nimport org.springframework.amqp.rabbit.connection.CorrelationData;\nimport org.springframework.amqp.rabbit.core.RabbitTemplate;\nimport org.springframework.stereotype.Component;\n\nimport javax.annotation.Resource;\n\n/**\n *  版权所有 © Copyright 2012<br>\n *\n * @Author： 蒙大拿\n * @Date：2021/9/13 4:29 下午\n * @Description\n * @About： https://github.com/DemoMeng\n */\n\n@Component\n@Slf4j\npublic class MessageDeadLetterProvider {\n\n    @Resource\n    private RabbitTemplate rabbitTemplate;\n\n    /**\n     * 【消息发送确认1】 消息发送到交换器Exchange后触发回调\n     */\n    private final RabbitTemplate.ConfirmCallback confirmCallback = new RabbitTemplate.ConfirmCallback() {\n        /**\n         * @param correlationData 唯一标识，有了这个唯一标识，我们就知道可以确认（失败）哪一条消息了\n         * @param ack  是否投递成功\n         * @param cause 失败原因\n         */\n        @Override\n        public void confirm(CorrelationData correlationData, boolean ack, String cause) {\n            String messageId = correlationData.getId();\n            log.info("【死信队列】消息成功投递触发了【提供者】的回调。。。");\n            //返回成功，表示消息被正常投递\n            if (ack) {\n                log.info("【死信队列】信息投递成功，messageId:{}",messageId);\n            } else {\n                log.error("【死信队列】消费信息失败，messageId:{} 原因:{}",messageId,cause);\n                //TODO 重新执行\n            }\n        }\n    };\n\n\n    /***\n     * 【消息发送确认2】消息从交换器发送到对应队列\n     * 如果消息从交换器发送到对应队列失败时触发\n     * 这个方法可以不用重写，因为交换器和队列是在代码中绑定的，若回调了这个方法则说明交换器和队列绑定的问题\n     * */\n    private final RabbitTemplate.ReturnsCallback returnsCallback = new RabbitTemplate.ReturnsCallback(){\n        @Override\n        public void returnedMessage(ReturnedMessage returnedMessage) {\n            log.info("【死信队列】消息经交换器发送到队列失败触发，回调参数：{}",returnedMessage);\n            //TODO 重新执行\n        }\n    };\n\n\n    /**\n     *  包含发送消息以及添加 confirm 监听、添加 return 监听。\n     *  如果消费端要设置为手工 ACK ，那么生产端发送消息的时候一定发送 correlationData ，并且全局唯一，用以唯一标识消息\n     */\n    public void send(MessageDTO dto){\n        //设置投递回调\n        rabbitTemplate.setConfirmCallback(this.confirmCallback);\n        rabbitTemplate.setReturnsCallback(this.returnsCallback);\n        CorrelationData correlationData = new CorrelationData();\n        correlationData.setId(dto.getMessageId());\n        //正常的消息投递\n        rabbitTemplate.convertAndSend(\n                Constant.DEAD_EXCHANGE,\n                Constant.DEAD_ROUTING_KEY,\n                dto,\n                correlationData);\n    }\n}\n')])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br"),a("span",{staticClass:"line-number"},[n._v("2")]),a("br"),a("span",{staticClass:"line-number"},[n._v("3")]),a("br"),a("span",{staticClass:"line-number"},[n._v("4")]),a("br"),a("span",{staticClass:"line-number"},[n._v("5")]),a("br"),a("span",{staticClass:"line-number"},[n._v("6")]),a("br"),a("span",{staticClass:"line-number"},[n._v("7")]),a("br"),a("span",{staticClass:"line-number"},[n._v("8")]),a("br"),a("span",{staticClass:"line-number"},[n._v("9")]),a("br"),a("span",{staticClass:"line-number"},[n._v("10")]),a("br"),a("span",{staticClass:"line-number"},[n._v("11")]),a("br"),a("span",{staticClass:"line-number"},[n._v("12")]),a("br"),a("span",{staticClass:"line-number"},[n._v("13")]),a("br"),a("span",{staticClass:"line-number"},[n._v("14")]),a("br"),a("span",{staticClass:"line-number"},[n._v("15")]),a("br"),a("span",{staticClass:"line-number"},[n._v("16")]),a("br"),a("span",{staticClass:"line-number"},[n._v("17")]),a("br"),a("span",{staticClass:"line-number"},[n._v("18")]),a("br"),a("span",{staticClass:"line-number"},[n._v("19")]),a("br"),a("span",{staticClass:"line-number"},[n._v("20")]),a("br"),a("span",{staticClass:"line-number"},[n._v("21")]),a("br"),a("span",{staticClass:"line-number"},[n._v("22")]),a("br"),a("span",{staticClass:"line-number"},[n._v("23")]),a("br"),a("span",{staticClass:"line-number"},[n._v("24")]),a("br"),a("span",{staticClass:"line-number"},[n._v("25")]),a("br"),a("span",{staticClass:"line-number"},[n._v("26")]),a("br"),a("span",{staticClass:"line-number"},[n._v("27")]),a("br"),a("span",{staticClass:"line-number"},[n._v("28")]),a("br"),a("span",{staticClass:"line-number"},[n._v("29")]),a("br"),a("span",{staticClass:"line-number"},[n._v("30")]),a("br"),a("span",{staticClass:"line-number"},[n._v("31")]),a("br"),a("span",{staticClass:"line-number"},[n._v("32")]),a("br"),a("span",{staticClass:"line-number"},[n._v("33")]),a("br"),a("span",{staticClass:"line-number"},[n._v("34")]),a("br"),a("span",{staticClass:"line-number"},[n._v("35")]),a("br"),a("span",{staticClass:"line-number"},[n._v("36")]),a("br"),a("span",{staticClass:"line-number"},[n._v("37")]),a("br"),a("span",{staticClass:"line-number"},[n._v("38")]),a("br"),a("span",{staticClass:"line-number"},[n._v("39")]),a("br"),a("span",{staticClass:"line-number"},[n._v("40")]),a("br"),a("span",{staticClass:"line-number"},[n._v("41")]),a("br"),a("span",{staticClass:"line-number"},[n._v("42")]),a("br"),a("span",{staticClass:"line-number"},[n._v("43")]),a("br"),a("span",{staticClass:"line-number"},[n._v("44")]),a("br"),a("span",{staticClass:"line-number"},[n._v("45")]),a("br"),a("span",{staticClass:"line-number"},[n._v("46")]),a("br"),a("span",{staticClass:"line-number"},[n._v("47")]),a("br"),a("span",{staticClass:"line-number"},[n._v("48")]),a("br"),a("span",{staticClass:"line-number"},[n._v("49")]),a("br"),a("span",{staticClass:"line-number"},[n._v("50")]),a("br"),a("span",{staticClass:"line-number"},[n._v("51")]),a("br"),a("span",{staticClass:"line-number"},[n._v("52")]),a("br"),a("span",{staticClass:"line-number"},[n._v("53")]),a("br"),a("span",{staticClass:"line-number"},[n._v("54")]),a("br"),a("span",{staticClass:"line-number"},[n._v("55")]),a("br"),a("span",{staticClass:"line-number"},[n._v("56")]),a("br"),a("span",{staticClass:"line-number"},[n._v("57")]),a("br"),a("span",{staticClass:"line-number"},[n._v("58")]),a("br"),a("span",{staticClass:"line-number"},[n._v("59")]),a("br"),a("span",{staticClass:"line-number"},[n._v("60")]),a("br"),a("span",{staticClass:"line-number"},[n._v("61")]),a("br"),a("span",{staticClass:"line-number"},[n._v("62")]),a("br"),a("span",{staticClass:"line-number"},[n._v("63")]),a("br"),a("span",{staticClass:"line-number"},[n._v("64")]),a("br"),a("span",{staticClass:"line-number"},[n._v("65")]),a("br"),a("span",{staticClass:"line-number"},[n._v("66")]),a("br"),a("span",{staticClass:"line-number"},[n._v("67")]),a("br"),a("span",{staticClass:"line-number"},[n._v("68")]),a("br"),a("span",{staticClass:"line-number"},[n._v("69")]),a("br"),a("span",{staticClass:"line-number"},[n._v("70")]),a("br"),a("span",{staticClass:"line-number"},[n._v("71")]),a("br"),a("span",{staticClass:"line-number"},[n._v("72")]),a("br"),a("span",{staticClass:"line-number"},[n._v("73")]),a("br"),a("span",{staticClass:"line-number"},[n._v("74")]),a("br"),a("span",{staticClass:"line-number"},[n._v("75")]),a("br"),a("span",{staticClass:"line-number"},[n._v("76")]),a("br"),a("span",{staticClass:"line-number"},[n._v("77")]),a("br"),a("span",{staticClass:"line-number"},[n._v("78")]),a("br"),a("span",{staticClass:"line-number"},[n._v("79")]),a("br"),a("span",{staticClass:"line-number"},[n._v("80")]),a("br"),a("span",{staticClass:"line-number"},[n._v("81")]),a("br"),a("span",{staticClass:"line-number"},[n._v("82")]),a("br"),a("span",{staticClass:"line-number"},[n._v("83")]),a("br"),a("span",{staticClass:"line-number"},[n._v("84")]),a("br")])]),a("h2",{attrs:{id:"_3-消费方消费消息"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-消费方消费消息"}},[n._v("#")]),n._v(" 3. 消费方消费消息")]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v('package com.mqz.better.rabbitmq.consumer.web;\n\nimport com.mqz.better.rabbitmq.common.constants.Constant;\nimport com.mqz.better.rabbitmq.common.model.dto.MessageDTO;\nimport com.rabbitmq.client.Channel;\nimport lombok.extern.slf4j.Slf4j;\nimport org.springframework.amqp.core.Message;\nimport org.springframework.amqp.rabbit.annotation.Exchange;\nimport org.springframework.amqp.rabbit.annotation.Queue;\nimport org.springframework.amqp.rabbit.annotation.QueueBinding;\nimport org.springframework.amqp.rabbit.annotation.RabbitListener;\nimport org.springframework.amqp.support.AmqpHeaders;\nimport org.springframework.messaging.handler.annotation.Headers;\nimport org.springframework.messaging.handler.annotation.Payload;\nimport org.springframework.stereotype.Component;\n\nimport java.io.IOException;\nimport java.util.Map;\n\n/**\n *  版权所有 © Copyright 2012<br>\n *\n * @Author： 蒙大拿\n * @Date：2021/9/11 4:20 下午\n * @Description\n * @About： https://github.com/DemoMeng\n */\n@Component\n@Slf4j\npublic class MessageDeadConsumer {\n\n    @RabbitListener(\n        bindings = @QueueBinding(//数据是否持久化\n            value = @Queue(value = Constant.DEAD_QUEUE,durable = "true"),\n            exchange = @Exchange(name = Constant.DEAD_EXCHANGE, durable = "true",type = "x-dead-letter-exchange"),\n            key= Constant.DEAD_ROUTING_KEY\n        )\n    )\n    public void onDo(@Payload MessageDTO dto,\n                     Message message,\n                     @Headers Map<String, Object> headers,\n                     Channel channel) throws IOException {\n        log.info("【死信】收到消息，开始消费");\n        log.info("【死信】  message参数:{}",message.toString());\n        log.info("【死信】  dto参数:{}",dto.toString());\n        //模拟消息变成死信\n        int i =  10 / 0;\n        Long deliveryTag = (Long) headers.get(AmqpHeaders.DELIVERY_TAG);\n        log.info("【死信】:deliveryTag:{}",deliveryTag);\n        channel.basicAck(deliveryTag,false);\n        log.info("【死信】消费完成");\n    }\n}\n\n')])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br"),a("span",{staticClass:"line-number"},[n._v("2")]),a("br"),a("span",{staticClass:"line-number"},[n._v("3")]),a("br"),a("span",{staticClass:"line-number"},[n._v("4")]),a("br"),a("span",{staticClass:"line-number"},[n._v("5")]),a("br"),a("span",{staticClass:"line-number"},[n._v("6")]),a("br"),a("span",{staticClass:"line-number"},[n._v("7")]),a("br"),a("span",{staticClass:"line-number"},[n._v("8")]),a("br"),a("span",{staticClass:"line-number"},[n._v("9")]),a("br"),a("span",{staticClass:"line-number"},[n._v("10")]),a("br"),a("span",{staticClass:"line-number"},[n._v("11")]),a("br"),a("span",{staticClass:"line-number"},[n._v("12")]),a("br"),a("span",{staticClass:"line-number"},[n._v("13")]),a("br"),a("span",{staticClass:"line-number"},[n._v("14")]),a("br"),a("span",{staticClass:"line-number"},[n._v("15")]),a("br"),a("span",{staticClass:"line-number"},[n._v("16")]),a("br"),a("span",{staticClass:"line-number"},[n._v("17")]),a("br"),a("span",{staticClass:"line-number"},[n._v("18")]),a("br"),a("span",{staticClass:"line-number"},[n._v("19")]),a("br"),a("span",{staticClass:"line-number"},[n._v("20")]),a("br"),a("span",{staticClass:"line-number"},[n._v("21")]),a("br"),a("span",{staticClass:"line-number"},[n._v("22")]),a("br"),a("span",{staticClass:"line-number"},[n._v("23")]),a("br"),a("span",{staticClass:"line-number"},[n._v("24")]),a("br"),a("span",{staticClass:"line-number"},[n._v("25")]),a("br"),a("span",{staticClass:"line-number"},[n._v("26")]),a("br"),a("span",{staticClass:"line-number"},[n._v("27")]),a("br"),a("span",{staticClass:"line-number"},[n._v("28")]),a("br"),a("span",{staticClass:"line-number"},[n._v("29")]),a("br"),a("span",{staticClass:"line-number"},[n._v("30")]),a("br"),a("span",{staticClass:"line-number"},[n._v("31")]),a("br"),a("span",{staticClass:"line-number"},[n._v("32")]),a("br"),a("span",{staticClass:"line-number"},[n._v("33")]),a("br"),a("span",{staticClass:"line-number"},[n._v("34")]),a("br"),a("span",{staticClass:"line-number"},[n._v("35")]),a("br"),a("span",{staticClass:"line-number"},[n._v("36")]),a("br"),a("span",{staticClass:"line-number"},[n._v("37")]),a("br"),a("span",{staticClass:"line-number"},[n._v("38")]),a("br"),a("span",{staticClass:"line-number"},[n._v("39")]),a("br"),a("span",{staticClass:"line-number"},[n._v("40")]),a("br"),a("span",{staticClass:"line-number"},[n._v("41")]),a("br"),a("span",{staticClass:"line-number"},[n._v("42")]),a("br"),a("span",{staticClass:"line-number"},[n._v("43")]),a("br"),a("span",{staticClass:"line-number"},[n._v("44")]),a("br"),a("span",{staticClass:"line-number"},[n._v("45")]),a("br"),a("span",{staticClass:"line-number"},[n._v("46")]),a("br"),a("span",{staticClass:"line-number"},[n._v("47")]),a("br"),a("span",{staticClass:"line-number"},[n._v("48")]),a("br"),a("span",{staticClass:"line-number"},[n._v("49")]),a("br"),a("span",{staticClass:"line-number"},[n._v("50")]),a("br"),a("span",{staticClass:"line-number"},[n._v("51")]),a("br"),a("span",{staticClass:"line-number"},[n._v("52")]),a("br"),a("span",{staticClass:"line-number"},[n._v("53")]),a("br"),a("span",{staticClass:"line-number"},[n._v("54")]),a("br")])]),a("h2",{attrs:{id:"_4-死信重入队列的消费方重新消费消息"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-死信重入队列的消费方重新消费消息"}},[n._v("#")]),n._v(" 4. 死信重入队列的消费方重新消费消息")]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v('package com.mqz.better.rabbitmq.consumer.web;\n\nimport com.mqz.better.rabbitmq.common.constants.Constant;\nimport com.mqz.better.rabbitmq.common.model.dto.MessageDTO;\nimport com.rabbitmq.client.Channel;\nimport lombok.extern.slf4j.Slf4j;\nimport org.springframework.amqp.core.Message;\nimport org.springframework.amqp.rabbit.annotation.Exchange;\nimport org.springframework.amqp.rabbit.annotation.Queue;\nimport org.springframework.amqp.rabbit.annotation.QueueBinding;\nimport org.springframework.amqp.rabbit.annotation.RabbitListener;\nimport org.springframework.amqp.support.AmqpHeaders;\nimport org.springframework.messaging.handler.annotation.Headers;\nimport org.springframework.messaging.handler.annotation.Payload;\nimport org.springframework.stereotype.Component;\n\nimport java.io.IOException;\nimport java.util.Map;\n\n/**\n *  版权所有 © Copyright 2012<br>\n *\n * @Author： 蒙大拿\n * @Date：2021/9/11 4:20 下午\n * @Description\n * @About： https://github.com/DemoMeng\n */\n@Component\n@Slf4j\npublic class MessageDeadRequeueConsumer {\n\n    @RabbitListener(\n        bindings = @QueueBinding(//数据是否持久化\n            value = @Queue(value = Constant.DEAD_QUEUE_RE,durable = "true"),\n            exchange = @Exchange(name = Constant.DEAD_EXCHANGE, durable = "true",type = "x-dead-letter-exchange"),\n            key= Constant.DEAD_ROUTING_KEY\n        )\n    )\n    public void onDo(@Payload MessageDTO dto,\n                     Message message,\n                     @Headers Map<String, Object> headers,\n                     Channel channel) throws IOException {\n        //模拟业务处理\n        try {\n            Thread.sleep(15000);\n        } catch (InterruptedException e) {\n            e.printStackTrace();\n        }\n\n        log.info("【死信-重入队列】收到消息，开始消费");\n        log.info("【死信-重入队列】  message参数:{}",message.toString());\n        log.info("【死信-重入队列】  dto参数:{}",dto.toString());\n        Long deliveryTag = (Long) headers.get(AmqpHeaders.DELIVERY_TAG);\n        log.info("【死信-重入队列】:deliveryTag:{}",deliveryTag);\n        channel.basicAck(deliveryTag,false);\n        log.info("【死信-重入队列】消费完成");\n    }\n}\n  \n  \n')])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br"),a("span",{staticClass:"line-number"},[n._v("2")]),a("br"),a("span",{staticClass:"line-number"},[n._v("3")]),a("br"),a("span",{staticClass:"line-number"},[n._v("4")]),a("br"),a("span",{staticClass:"line-number"},[n._v("5")]),a("br"),a("span",{staticClass:"line-number"},[n._v("6")]),a("br"),a("span",{staticClass:"line-number"},[n._v("7")]),a("br"),a("span",{staticClass:"line-number"},[n._v("8")]),a("br"),a("span",{staticClass:"line-number"},[n._v("9")]),a("br"),a("span",{staticClass:"line-number"},[n._v("10")]),a("br"),a("span",{staticClass:"line-number"},[n._v("11")]),a("br"),a("span",{staticClass:"line-number"},[n._v("12")]),a("br"),a("span",{staticClass:"line-number"},[n._v("13")]),a("br"),a("span",{staticClass:"line-number"},[n._v("14")]),a("br"),a("span",{staticClass:"line-number"},[n._v("15")]),a("br"),a("span",{staticClass:"line-number"},[n._v("16")]),a("br"),a("span",{staticClass:"line-number"},[n._v("17")]),a("br"),a("span",{staticClass:"line-number"},[n._v("18")]),a("br"),a("span",{staticClass:"line-number"},[n._v("19")]),a("br"),a("span",{staticClass:"line-number"},[n._v("20")]),a("br"),a("span",{staticClass:"line-number"},[n._v("21")]),a("br"),a("span",{staticClass:"line-number"},[n._v("22")]),a("br"),a("span",{staticClass:"line-number"},[n._v("23")]),a("br"),a("span",{staticClass:"line-number"},[n._v("24")]),a("br"),a("span",{staticClass:"line-number"},[n._v("25")]),a("br"),a("span",{staticClass:"line-number"},[n._v("26")]),a("br"),a("span",{staticClass:"line-number"},[n._v("27")]),a("br"),a("span",{staticClass:"line-number"},[n._v("28")]),a("br"),a("span",{staticClass:"line-number"},[n._v("29")]),a("br"),a("span",{staticClass:"line-number"},[n._v("30")]),a("br"),a("span",{staticClass:"line-number"},[n._v("31")]),a("br"),a("span",{staticClass:"line-number"},[n._v("32")]),a("br"),a("span",{staticClass:"line-number"},[n._v("33")]),a("br"),a("span",{staticClass:"line-number"},[n._v("34")]),a("br"),a("span",{staticClass:"line-number"},[n._v("35")]),a("br"),a("span",{staticClass:"line-number"},[n._v("36")]),a("br"),a("span",{staticClass:"line-number"},[n._v("37")]),a("br"),a("span",{staticClass:"line-number"},[n._v("38")]),a("br"),a("span",{staticClass:"line-number"},[n._v("39")]),a("br"),a("span",{staticClass:"line-number"},[n._v("40")]),a("br"),a("span",{staticClass:"line-number"},[n._v("41")]),a("br"),a("span",{staticClass:"line-number"},[n._v("42")]),a("br"),a("span",{staticClass:"line-number"},[n._v("43")]),a("br"),a("span",{staticClass:"line-number"},[n._v("44")]),a("br"),a("span",{staticClass:"line-number"},[n._v("45")]),a("br"),a("span",{staticClass:"line-number"},[n._v("46")]),a("br"),a("span",{staticClass:"line-number"},[n._v("47")]),a("br"),a("span",{staticClass:"line-number"},[n._v("48")]),a("br"),a("span",{staticClass:"line-number"},[n._v("49")]),a("br"),a("span",{staticClass:"line-number"},[n._v("50")]),a("br"),a("span",{staticClass:"line-number"},[n._v("51")]),a("br"),a("span",{staticClass:"line-number"},[n._v("52")]),a("br"),a("span",{staticClass:"line-number"},[n._v("53")]),a("br"),a("span",{staticClass:"line-number"},[n._v("54")]),a("br"),a("span",{staticClass:"line-number"},[n._v("55")]),a("br"),a("span",{staticClass:"line-number"},[n._v("56")]),a("br"),a("span",{staticClass:"line-number"},[n._v("57")]),a("br"),a("span",{staticClass:"line-number"},[n._v("58")]),a("br"),a("span",{staticClass:"line-number"},[n._v("59")]),a("br"),a("span",{staticClass:"line-number"},[n._v("60")]),a("br")])])])}),[],!1,null,null,null);s.default=t.exports}}]);