(window.webpackJsonp=window.webpackJsonp||[]).push([[53],{443:function(s,n,e){"use strict";e.r(n);var a=e(54),t=Object(a.a)({},(function(){var s=this,n=s.$createElement,e=s._self._c||n;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("h1",{attrs:{id:"redis分布式锁"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#redis分布式锁"}},[s._v("#")]),s._v(" Redis分布式锁")]),s._v(" "),e("p",[s._v("主要用到三个命令：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("SETNX :  设置锁，如果该锁未设置的情况下 （set if not exist）\nEXPIRE :   设置锁的过期时间，避免在异常情况下该锁成为死锁\nDELETE ：  业务执行成功后释放锁  \n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("p",[s._v("实现的原理：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("1. 获取锁： SETNX x，并且需要使用：EXPIRE 设置锁过期时间，这两个命令需要是原子性，否则也可能导致锁变成死锁。\n                  key资源的唯一标识（商品id），value值是uuid或者是用户id，这样释放锁的时候，需要根据value进行判断，只释放当前用户加的锁。\n2. 释放锁： 根据value值判断是不是他自己加的锁，是则释放，反之不做操作               \n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("p",[s._v("具体代码如下：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('public String testRedisLock2(){\n    // 这里的key是商品的唯一标识，多个用户操作的时候，会使用这个共同的key进行抢占加锁 ！！\n    String key = new StringBuffer().append("iPhone14pro_ID_123").toString();\n    String uuid = UUID.randomUUID().toString();\n    // 1. key值取商品的唯一标识，value值设置为uuid，考虑了多个用户共同抢占资源，uuid代表的就是某一个用户\n    Boolean lockFlag = redisTemplate.opsForValue().setIfAbsent(key, uuid, 5, TimeUnit.SECONDS);\n    if(lockFlag){\n        // 2. 加锁成功\n        log.info("加锁成功，uuid={}，商品唯一标识key={}",uuid,key);\n        // 3. 业务处理\n        System.out.println("这里执行业务处理......");\n        // 4. 业务处理完了后释放锁\n        String value = (String) redisTemplate.opsForValue().get(key);\n        // 5. 根据uuid，判断是否是当前用户加的锁 （因为多用户场景下）\n        if(uuid.equals(value)){\n            // 6. 释放锁这里根据key值进行释放\n            redisTemplate.delete(key);\n        }\n        //TODO 问题： 第4、5、6步骤操作不是原子性的，可能存在数据一致性问题无法保证，所以需要借助lua脚本保证redis这步骤操作是原子性的\n    }else{\n        // 2. 加锁失败，可以等待一段时间重新加锁，可以使用 Retryable 方式，重试3次\n        // 3. TODO 重试加锁\n    }\n    return "OK";\n}\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br")])]),e("p",[s._v("因为存在操作原子性的问题，第4、5、6步骤保证不了，所以使用了lua脚本来让redis操作")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('public String testRedisLock3(){\n    // 这里的key是商品的唯一标识，多个用户操作的时候，会使用这个共同的key进行抢占加锁 ！！\n    String key = new StringBuffer().append("iPhone14pro_ID_123").toString();\n    String uuid = UUID.randomUUID().toString();\n    // 1. 给该操作的用户加锁，key值取用户id+业务场景，value值设置为uuid，考虑了多线程场景下\n    Boolean lockFlag = redisTemplate.opsForValue().setIfAbsent(key, uuid, 5, TimeUnit.SECONDS);\n    if(lockFlag){\n        // 2. 加锁成功\n        log.info("加锁成功，uuid={}，商品唯一标识key={}",uuid,key);\n        // 3. 业务处理\n        System.out.println("这里执行业务处理......");\n        // 4. 通过lua脚本保证释放锁的操作是原子性的\n        String script = "if redis.call(\'get\',KEYS[1]) == ARGV[1] then return redis.call(\'del\',KEYS[1]) else return 0 end";\n        redisTemplate.execute(new DefaultRedisScript<Long>(script, Long.class), Arrays.asList("lock"), uuid);\n        // KEYS[1] 就是 execute方法的第二个参数：List keys的数组第一个\n        // ARGV[1] 就是 execute方法的第三个参数：uuid ，因为是Object... args，所以依次类推\n    }else{\n        // 2. 加锁失败，可以等待一段时间重新加锁，可以使用 Retryable 方式，重试3次\n        // 3. TODO 重试加锁\n    }\n    return "OK";\n}\n\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br")])])])}),[],!1,null,null,null);n.default=t.exports}}]);